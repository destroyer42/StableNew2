PR: PR-PIPE-024 â€” Main sampler/scheduler normalization (no ADetailer changes)
NOTE: This is a guided diff. Function names and nearby context may differ; adapt to the actual code while preserving behavior.

--- a/src/utils/config.py
+++ b/src/utils/config.py
@@
+from typing import Dict, Optional
+
+
+def _normalize_scheduler_name(scheduler: Optional[str]) -> Optional[str]:
+    """Normalize scheduler names into a form safe for the WebUI API.
+
+    Rules:
+    - None or empty values mean no explicit scheduler.
+    - Strings "None" and "Automatic" (any case) also mean no explicit scheduler.
+    """
+    if scheduler is None:
+        return None
+
+    s = str(scheduler).strip()
+    if not s:
+        return None
+
+    lowered = s.lower()
+    if lowered in ("none", "automatic"):
+        return None
+
+    return s
+
+
+def build_sampler_scheduler_payload(
+    sampler_name: Optional[str],
+    scheduler_name: Optional[str],
+) -> Dict[str, str]:
+    """Build the sampler-related portion of the WebUI payload.
+
+    Behavior:
+    - Always set a sampler_name if possible.
+    - If a real scheduler is provided (for example "Karras"), set:
+        sampler_name = "<sampler> <scheduler>"
+        scheduler    = "<scheduler>"
+    - If scheduler is absent/None/"None"/"Automatic", send only sampler_name and
+      omit the scheduler field so WebUI chooses its default.
+    """
+    payload: Dict[str, str] = {}
+
+    sampler = (sampler_name or "").strip()
+    if not sampler:
+        # No sampler configured; let callers decide how to handle this.
+        return payload
+
+    normalized_scheduler = _normalize_scheduler_name(scheduler_name)
+
+    if normalized_scheduler:
+        combined = f"{sampler} {normalized_scheduler}"
+        payload["sampler_name"] = combined
+        payload["scheduler"] = normalized_scheduler
+    else:
+        payload["sampler_name"] = sampler
+
+    return payload
+
@@  # Inside the txt2img/img2img payload builder(s)
-    # Existing sampler/scheduler assignments, example:
-    # if config.sampler_name:
-    #     payload["sampler_name"] = config.sampler_name
-    #
-    # if getattr(config, "scheduler_name", None):
-    #     payload["scheduler"] = config.scheduler_name
+    # Centralized sampler + scheduler serialization.
+    sampler_scheduler = build_sampler_scheduler_payload(
+        sampler_name=getattr(config, "sampler_name", None),
+        scheduler_name=getattr(config, "scheduler_name", None),
+    )
+    payload.update(sampler_scheduler)
+
+    # Leave the rest of the payload building code unchanged.
+
--- a/tests/test_config_passthrough.py
+++ b/tests/test_config_passthrough.py
@@
+from src.utils.config import build_sampler_scheduler_payload
+
+
+def test_sampler_scheduler_passthrough_with_explicit_scheduler():
+    """When a real scheduler is selected, the payload should include
+    both a combined sampler_name and an explicit scheduler field."""
+
+    payload = build_sampler_scheduler_payload(
+        sampler_name="DPM++ 2M",
+        scheduler_name="Karras",
+    )
+
+    assert payload["sampler_name"] == "DPM++ 2M Karras"
+    assert payload["scheduler"] == "Karras"
+
+
+def test_sampler_scheduler_passthrough_without_scheduler():
+    """When no scheduler is configured (None / empty / 'None' / 'Automatic'),
+    the payload should omit the scheduler field and keep sampler_name."""
+
+    for raw_sched in (None, "", "None", "none", "Automatic", "automatic"):
+        payload = build_sampler_scheduler_payload(
+            sampler_name="DPM++ 2M",
+            scheduler_name=raw_sched,
+        )
+
+        assert payload["sampler_name"] == "DPM++ 2M"
+        assert "scheduler" not in payload
