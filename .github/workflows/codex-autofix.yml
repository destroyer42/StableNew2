name: Codex AutoFix

on:
  issue_comment:
    types:
      - created
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull request number to analyze"
        required: true
      test_command:
        description: "Command Codex should attempt to fix"
        required: false
        default: "pytest --maxfail=1 -q"

permissions:
  contents: read
  pull-requests: write

jobs:
  run:
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/codex-autofix'))
    runs-on: ubuntu-latest
    env:
      CODEX_AUTOFIX_COMMAND: ${{ inputs.test_command || 'pytest --maxfail=1 -q' }}
    steps:
      - name: Determine pull request metadata
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.eventName === 'issue_comment'
              ? context.payload.issue.number
              : parseInt('${{ inputs.pr_number }}');
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            core.setOutput('number', prNumber);
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_repo', pr.head.repo.full_name);
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('base_ref', pr.base.ref);
      - name: Checkout pull request head
        uses: actions/checkout@v5
        with:
          repository: ${{ steps.pr.outputs.head_repo }}
          ref: ${{ steps.pr.outputs.head_ref }}
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai requests
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
      - name: Run Codex AutoFix
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python tools/codex_autofix_runner.py \
            --repo "${{ steps.pr.outputs.head_repo }}" \
            --pr "${{ steps.pr.outputs.number }}" \
            --head-sha "${{ steps.pr.outputs.head_sha }}" \
            --command "$CODEX_AUTOFIX_COMMAND"
