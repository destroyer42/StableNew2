# Changelog

## [Unreleased]

### Added
- **[PR-CI-JOURNEY-001] CI Journey Tests with WebUI Mocks** - Journey tests now run on GitHub Actions CI with WebUI mocks, validating clean shutdown, thread management, and E2E workflows on every PR; uses ubuntu-latest runners for fast, parallel execution; mock infrastructure in `tests/mocks/` provides realistic WebUI API responses (txt2img, img2img, upscale, controlnet); self-hosted runner continues to run with real WebUI for actual image validation; CI-aware pytest fixtures in `tests/journeys/conftest.py` automatically switch between mock and real WebUI based on `CI` environment variable; added CI mode detection helpers to `journey_helpers_v2.py`; created `.github/workflows/journey-tests.yml` workflow that runs 9 journey tests in parallel with Xvfb for GUI support; documentation updated in README.md, CHANGELOG.md, and DOCS_INDEX_v2.6.md (files: `tests/mocks/__init__.py`, `tests/mocks/mock_responses.py`, `tests/mocks/webui_mock_server.py`, `tests/mocks/webui_mock_client.py`, `tests/mocks/test_webui_mock.py`, `tests/journeys/conftest.py`, `tests/journeys/journey_helpers_v2.py`, `.github/workflows/journey-tests.yml`, `README.md`, `CHANGELOG.md`, `docs/DOCS_INDEX_v2.6.md`, `docs/PR-CI-JOURNEY-001.md`).
- **[PR-PROCESS-001] Windows CMD/Shell Process Cleanup & Crash Recovery** - Implemented three critical safety mechanisms to eliminate orphaned WebUI processes: (1) Enhanced `_kill_process_tree()` to explicitly scan for and kill cmd.exe and conhost.exe shell wrappers by working directory and cmdline patterns, catching processes left behind when .bat/.cmd files spawn python.exe then exit; (2) Added emergency atexit handler in main.py with global `_webui_manager_global` reference that kills WebUI processes even if GUI crashes during startup before normal shutdown paths execute; (3) Enhanced orphan monitor from 5s to 2s check interval, added `_scan_for_orphaned_webui_processes()` to detect reparented processes without valid parents, and `_kill_all_webui_processes()` to handle GUI exit scenarios; eliminates "5-7 orphaned python.exe processes" issue documented in D-GUI-002, ensures port 7860 immediately available after StableNew exits in all scenarios (normal shutdown, GUI crash, early startup failure); Windows-specific fix with comprehensive test coverage (5 tests) and troubleshooting documentation; backward compatible (all changes are additive defensive measures) (files: `src/api/webui_process_manager.py`, `src/main.py`, `tests/api/test_webui_process_cleanup.py`, `docs/DEBUG HUB v2.6.md`, `CHANGELOG.md`).

### Changed
- **[PR-CLEANUP-002] Remove Outdated PR Status Files** - Organized documentation by moving 5 completed PR status files to `docs/archive/completed_prs/`, 7 root-level .md files to `docs/`, and 2 report files to `reports/`; cleaned root directory from 17 .md files to 3 essential ones (AGENTS.md, CHANGELOG.md, README.md); created archive structure for historical PR documentation (files: `docs/archive/completed_prs/`, `docs/`, `reports/`).
- **[PR-CLEANUP-001] Organize Root Directory** - Moved 32 test files from root to `tests/`, 5 utility scripts to `scripts/`, deleted 3 temporary files, and enhanced `.gitignore` with comprehensive patterns for test outputs, temporary files, and report artifacts; root directory now clean with only essential configuration and documentation files (files: moved 37 files, `.gitignore`).

### Fixed
- **[PR-METADATA-001] run_metadata/Manifest Reconciliation** - Added `run_id` cross-reference field to all stage manifests (txt2img, img2img, adetailer, upscale) for bidirectional linking between image manifests and parent run_metadata.json; enables easy traceability, reconciliation, and debugging; updated test to verify run_id presence in manifests; 2 tests passing (files: `src/pipeline/executor.py`, `tests/history/test_history_image_metadata_reconcile.py`, `docs/PR-METADATA-001-Manifest-Reconciliation.md`).
- **[PR-PREVIEW-001] Thumbnail Preview Default Off + Config Persistence** - Fixed preview panel checkbox to default to False (was True), preventing unnecessary thumbnail loading; removed buggy logic that overrode user checkbox state from pack config - user UI controls are now authoritative; fixed multiple state reset bugs where `_current_show_preview` was hardcoded to True when clearing preview (line 524), updating with summary (line 1050), and in checkbox handler (line 1023); state persistence already worked via `save_state()`/`restore_state()` but was being overridden; checkbox state now correctly persists through all operations (adding jobs to preview, adding to queue, clearing, updating); 10 comprehensive tests covering default, persistence, state resets, pack config override prevention, schema validation, and destroy behavior (files: `src/gui/preview_panel_v2.py`, `tests/test_pr_preview_001.py`, `docs/PR-PREVIEW-001-Thumbnail-Default-Off.md`).
- **img2img Stage Flag Defaults - Comprehensive Fix** - Fixed persistent img2img_enabled defaulting to True bug across SEVEN locations in the codebase: (1) app_controller.py line 2417 in `_apply_executor_config_to_gui` method, (2) preferences.py _DEFAULT_PIPELINE_CONTROLS dict, (3) state.py PipelineState.stage_img2img_enabled, (4-5) executor.py in two methods (_run_full_pipeline_impl and run_pack_pipeline), (6) config.py default pipeline config, and (7) sidebar_panel_v2.py stage_states initialization; all locations now correctly default img2img_enabled to False, matching txt2img=True behavior; this was causing img2img to be enabled on every config load operation, overriding user's saved preferences; issue had reappeared because fixes were applied incompletely to only some locations; now comprehensively fixed everywhere the default is referenced (files: `src/controller/app_controller.py`, `src/utils/preferences.py`, `src/gui/state.py`, `src/pipeline/executor.py`, `src/utils/config.py`, `src/gui/sidebar_panel_v2.py`).
- **OutputSettings.filename_template Removed - Architecture Simplification** - Removed unused `filename_template` field from `OutputSettings` dataclass; this field was never actually used by the runner and caused confusion during debugging by suggesting it controlled output filenames; runner uses hardcoded naming convention in pipeline_runner.py that incorporates matrix_slot_values, batch indices, prompt rows, and variant IDs to prevent filename collisions; removed method `_build_output_settings_for_matrix()` from prompt_pack_job_builder.py and all test references; `OutputSettings` now only specifies `base_output_dir`, making the architecture clearer and preventing future confusion about which layer controls filenames (files: `src/pipeline/job_models_v2.py`, `src/pipeline/prompt_pack_job_builder.py`, `tests/gui_v2/test_queue_panel_v2_normalized_jobs.py`).
- **Matrix Filename Overwrite Bug - Runner Fix** - Fixed critical bug where all matrix-expanded job variants were overwriting each other because `pipeline_runner.py` was constructing filenames without considering matrix slot values; runner was building filenames like `txt2img_p00_00_batch0.png` for all variants regardless of matrix values, causing 8 images to overwrite to just 2; modified runner to include matrix slot values in filenames for all stages (txt2img, adetailer, upscale), generating unique names like `txt2img_p00_00_wizard_forest_batch0.png` for each matrix combination; ensures all matrix variants produce distinct output files throughout the entire pipeline (files: `src/pipeline/pipeline_runner.py`).
- **Matrix Config Loading Bug** - Fixed bug where matrix expansion wasn't working because `get_matrix_slots_dict()` was accessing `metadata["matrix"]` instead of `metadata["pack_data"]["matrix"]`; updated extraction logic in `prompt_pack_utils.py` and `prompt_pack_job_builder.py` to correctly access matrix config from pack_data section; matrix expansion now creates correct number of NJRs with populated matrix_slot_values (files: `src/utils/prompt_pack_utils.py`, `src/pipeline/prompt_pack_job_builder.py`).
- **Matrix Filename Collision Bug** - Fixed bug where all matrix-expanded job variants used the same filename template (e.g., `{seed}.png`), causing images to overwrite each other; implemented `_build_output_settings_for_matrix()` method that appends matrix slot values to filename template, creating unique filenames like `{seed}_wizard_forest.png` for each variant; prevents overwrites and ensures all matrix combinations generate distinct output files (files: `src/pipeline/prompt_pack_job_builder.py`, `test_matrix_filenames.py`, `docs/MATRIX_FILENAME_FIX.md`).
- **Stage Flag Corruption - Sidebar Defaults** - Fixed persistent stage flag corruption where adetailer enabled would flip to img2img enabled on save/load; root cause was `sidebar_panel_v2.py` initializing `stage_states` BooleanVars with wrong defaults (`img2img: True`, `upscale: True`); these incorrect defaults overrode user checkbox selections during config save; corrected sidebar initialization to use proper defaults (`txt2img: True`, all others `False`); stage flags now persist correctly through save/load cycles (files: `src/gui/sidebar_panel_v2.py`).
- **Stage Flag Corruption on Load** - Fixed critical bug where loading a pack config would incorrectly enable img2img and upscale even if they were disabled when saved, and disable adetailer even if it was enabled; root cause was default config having `img2img_enabled: True` and `upscale_enabled: True` which overwrote saved values during merge; corrected defaults to match expected behavior (`txt2img_enabled: True`, all others `False`); all saved pack configs now load with correct stage flags (files: `src/utils/config.py`, `test_pack_config_flags.py`).
- **Empty Slot Accumulation** - Fixed issue where loading a pack with < 10 prompts would pad to 10 slots for UI, then save all 10 (including empty padding slots), causing blank prompts to accumulate on each save/load cycle; PromptPackModel.save_to_file() now filters out empty slots (no text, negative, embeddings, or LoRAs) before saving, keeping only slots with actual content; slots with only negative prompts or only embeddings/LoRAs are correctly preserved (files: `src/gui/models/prompt_pack_model.py`, `test_empty_slot_removal.py`).
- **JSON Collision Bug** - Fixed critical data loss issue where prompt pack matrix config and pipeline config would overwrite each other by unifying both into a single JSON file with `pack_data` and `preset_data` sections; PromptPackModel now preserves pipeline config when saving matrix data, ConfigManager preserves matrix config when saving pipeline settings; added backward compatibility for legacy formats; created migration script to convert existing packs to unified format; all 34 packs in packs/ folder successfully migrated with backups (files: `src/gui/models/prompt_pack_model.py`, `src/utils/config.py`, `test_json_unification.py`, `migrate_pack_json.py`, `docs/JSON_UNIFICATION_FIX.md`).

### Changed
- [PR-GUI-003-C] Matrix Runtime Integration (V2.6) - **COMPLETE** - Implemented end-to-end runtime integration for Matrix Tab slots; Created `src/utils/prompt_pack_utils.py` with `load_pack_metadata()`, `get_matrix_slots_dict()`, and `get_matrix_config_summary()` utilities; Modified `PromptPackNormalizedJobBuilder.build_jobs()` to call new `_expand_entry_by_matrix()` method that loads pack JSON, extracts matrix slots, generates Cartesian product of all slot values, and creates one `PackJobEntry` per combination with `matrix_slot_values` set; Updated `UnifiedPromptResolver.resolve_from_pack()` to apply `_substitute_matrix_tokens()` to both `subject_template` and `quality_line` so [[tokens]] in all prompt sections get replaced with matrix values; Matrix expansion respects `matrix.limit` from JSON config; System now functional end-to-end: users define slots in GUI → save pack → add to pipeline → jobs generated with expanded prompts; 2 integration tests pass (matrix expansion + token replacement); 73 existing tests pass with 0 regressions; Files: `src/utils/prompt_pack_utils.py`, `src/pipeline/prompt_pack_job_builder.py`, `src/pipeline/resolution_layer.py`, `test_pr_gui_003c_runtime.py`, `packs/test_matrix_pack.txt`, `packs/test_matrix_pack.json`, `PR-GUI-003-C-COMPLETE.md`.
- [PR-GUI-003-B] Matrix Tab in Prompt Tab (V2.6) - **COMPLETE** - Added dedicated Matrix tab to Prompt Tab for defining slot-based matrix configurations; Extended `PromptPackModel` with `MatrixSlot` and `MatrixConfig` dataclasses; Implemented `MatrixTabPanel` widget with enable checkbox, mode selector, limit control, and slot table editor (name, values, delete); Added real-time Cartesian preview showing first 10 expanded combinations with total count; Implemented "Insert Slot..." buttons in positive/negative editors that insert `[[slot_name]]` tokens at cursor; Created `MatrixSlotPickerDialog` modal for slot selection; Integrated MatrixTabPanel into PromptTabFrame as second tab in notebook layout; Extended `PromptWorkspaceState` with `get_matrix_config()`, `set_matrix_config()`, `get_current_slot()`, and `mark_dirty()` methods; Auto-export TXT format with [[tokens]] preserved for Pipeline Tab compatibility when saving to packs/ folder; Multi-line negative prompts exported with `neg:` prefix; 14 comprehensive tests covering data model, serialization, backward compatibility, TXT export, preview generation; Files: `src/gui/models/prompt_pack_model.py`, `src/gui/widgets/matrix_tab_panel.py`, `src/gui/widgets/matrix_slot_picker.py`, `src/gui/views/prompt_tab_frame_v2.py`, `src/gui/prompt_workspace_state.py`, `tests/gui_v2/test_prompt_pack_model_matrix.py`, `docs/PR-GUI-003-B-Add-Matrix-Tab-To-PromptTab.md`.
- [PR-GUI-003-A] Negative Prompt Support in Prompt Tab (V2.6) - **COMPLETE** - Added negative prompt editing capability directly in the Prompt Tab's main UI; Extended `PromptSlot` dataclass with `negative: str = ""` field with full backward compatibility for legacy JSON files; Added negative prompt text editor below positive editor with 75%/25% height split using grid layout; Implemented `get_current_negative_text()` and `set_slot_negative()` state management methods; Added `_on_negative_modified()` event handler for real-time slot updates; Updated metadata panel to display separate positive/negative statistics (character count, line count); Integrated with Advanced Editor modal for roundtrip editing of negative prompts; LoRA/embedding detection now includes negative prompt text; All save/load operations preserve negative prompts in JSON format; Created comprehensive test suite with 19 passing tests covering data model, state management, and backward compatibility (files: `src/gui/models/prompt_pack_model.py`, `src/gui/prompt_workspace_state.py`, `src/gui/views/prompt_tab_frame_v2.py`, `tests/gui_v2/test_prompt_pack_model_negative.py`, `tests/gui_v2/test_prompt_workspace_state_negative.py`, `docs/PR-GUI-003-A-Add-Negative-Prompt-To-PromptTab.md`).
- [PR-CORE-E] Global Negative Integration + Config Sweep (V2.6) - **COMPLETE** - Added global negative prompt integration in `UnifiedPromptResolver`, controlled via app settings and per-stage pack JSON flags; Introduced `ConfigVariantPlanV2` for config sweeps (same prompt, many configs); Updated `JobBuilderV2` to expand rows × config_variants × matrix_variants × batches; Added `config_variant_label`, `config_variant_index`, `config_variant_overrides` fields to `NormalizedJobRecord` and `UnifiedJobSummary`; **NEW**: Implemented GUI config sweep controls with `ConfigSweepWidgetV2` in Pipeline Panel, added sweep state to `AppStateV2`, integrated controller to build `ConfigVariantPlanV2` from GUI state, updated Preview/Queue/History panels to display config variant metadata; Created comprehensive tests for config sweep expansion, override application, and GUI integration (files: `src/pipeline/config_variant_plan_v2.py`, `src/pipeline/job_builder_v2.py`, `src/pipeline/job_models_v2.py`, `src/pipeline/resolution_layer.py`, `src/gui/widgets/config_sweep_widget_v2.py`, `src/gui/pipeline_panel_v2.py`, `src/gui/app_state_v2.py`, `src/controller/pipeline_controller.py`, `src/gui/panels_v2/history_panel_v2.py`, `src/gui/panels_v2/queue_panel_v2.py`, `tests/pipeline/test_config_sweeps_v2.py`, `docs/PROMPT_PACK_LIFECYCLE_v2.6.md`, `reports/PR_CORE_E_IMPLEMENTATION_SUMMARY.md`).
- [PR-CORE-C] Queue/Runner Lifecycle Repair (V2.6) - JobService now enforces PromptPack-derived NormalizedJobRecords, validating pack IDs/prompts/stage chains, emitting a `job_submitted` lifecycle event, and logging the new SUBMITTED → RUNNING → COMPLETED transition so Debug Hub stays in sync (files: `src/controller/job_service.py`, `src/controller/job_lifecycle_logger.py`, `src/controller/app_controller.py`, `tests/controller/test_job_service_normalized_v2.py`, `docs/ARCHITECTURE_v2.5.md`, `docs/DEBUG_HUB_v2.5.md`, `docs/StableNew_Coding_and_Testing_v2.5.md`).
- [PR-D] Queue & History Lifecycle Alignment for JobBundles (V2.5 - Phase 2 Complete) - PipelineController now owns draft JobBundles with methods for add_job_part, add_job_parts_from_pack, clear_draft_bundle, and enqueue_draft_bundle; JobService emits status callbacks via set_status_callback for GUI updates; QueuePanelV2 adds upsert_job/remove_job DTO methods; new HistoryPanelV2 displays completed jobs with append_history_item; DTOs (JobBundleSummaryDTO, JobQueueItemDTO, JobHistoryItemDTO) provide GUI-safe abstractions; AppController wired to call PipelineController methods and refresh preview from DTOs; PreviewPanelV2.update_from_summary() added; JobService status callbacks registered for queue/history sync; "Add to Job" button now functional with prompt extraction from pipeline_panel.prompt_text (files: `src/controller/pipeline_controller.py`, `src/controller/app_controller.py`, `src/controller/job_service.py`, `src/gui/panels_v2/queue_panel_v2.py`, `src/gui/panels_v2/history_panel_v2.py`, `src/gui/preview_panel_v2.py`, `src/pipeline/job_models_v2.py`, `docs/pr_implementation/PR-D_Implementation_Summary.md`).
- [PR-0114C-Tx] Core run path & runner DI (V2.5) - AppController now builds JobService through a dedicated runner factory so `_execute_job` drives SingleNodeJobRunner, PipelineController relies on that same JobService, and new controller tests (plus docs) verify the DI-driven path without touching real runners (files: `src/controller/app_controller.py`, `src/controller/pipeline_controller.py`, `tests/controller/test_core_run_path_v2.py`, `docs/ARCHITECTURE_v2.5.md`, `docs/StableNew_Coding_and_Testing_v2.5.md`, `docs/pr_templates/PR-A-CoreRunPath_and_Runner_DI_v2.5.md`).
- [PR-A] Observability & debug harness (V2.5) - Adds `JobLifecycleLogger`, log-buffer support in `AppStateV2`, and `DebugLogPanelV2` inside the Pipeline tab so Add-to-Job/Add-to-Queue events and JobService runner transitions emit structured entries directly into the GUI; tests mirror the log buffer behavior and the panel refresh, while docs explain the new console (files: `src/controller/job_lifecycle_logger.py`, `src/gui/app_state_v2.py`, `src/controller/pipeline_controller.py`, `src/controller/app_controller.py`, `src/gui/panels_v2/debug_log_panel_v2.py`, `tests/controller/test_job_lifecycle_logger_v2.py`, `tests/gui_v2/test_debug_log_panel_v2.py`, `docs/DEBUG_HUB_v2.5.md`, `docs/StableNew_Coding_and_Testing_v2.5.md`).
- [PR-0128] Phase 8: Unified logging & telemetry harmonization (V2.5) - Centralizes `log_with_ctx`, adds JSONL sink + handler, wires AppController to the structured log stream for crash bundles, and extends `LogTracePanelV2` with subsystem/job filters so GUI logs now follow a single schema across phases 5-8 (files: `src/utils/logger.py`, `src/controller/app_controller.py`, `src/utils/diagnostics_bundle_v2.py`, `src/gui/log_trace_panel_v2.py`, `tests/utils/test_logger_v2.py`, `tests/gui_v2/test_log_display_v2.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`, `docs/pr_templates/PR-0128–Phase8_UnifiedLogging_and_Telemetry_v2.5.md`).
- [PR-0127] Phase 7: Retry semantics & intelligent recovery (V2.5) - Introduces `RetryPolicy` stage defaults, `SDWebUIClient` retry callbacks/backoff logging, `JobExecutionMetadata.retry_attempts`, structured retry envelopes, and targeted tests/documentation so transient WebUI failures are retried while crash bundles capture each attempt (files: `src/api/client.py`, `src/utils/retry_policy_v2.py`, `src/controller/job_service.py`, `src/controller/pipeline_controller.py`, `src/queue/job_model.py`, `src/queue/single_node_runner.py`, `tests/api/test_webui_retry_policy_v2.py`, `tests/controller/test_job_retry_metadata_v2.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`, `docs/pr_templates/PR-0127-Phase7_RetrySemantics_and_IntelligentRecovery_v2.5.md`).
- [PR-B] GUI job wiring & queue integration (V2.5) - PipelineTabFrame now binds AppStateV2 to PipelineController so preview jobs reflect normalized records, queue items derive from JobService state, and Queue/Running panels dispatch moves, pauses, and cancels through the canonical controller/JobService path; it also adds canonical job intent DTOs (`PipelineConfigSnapshot`, `JobPart`, `JobBundle`, `JobBundleBuilder`) so controllers have a single representation before handing work to `JobBuilderV2`. (files: `src/gui/app_state_v2.py`, `src/gui/views/pipeline_tab_frame_v2.py`, `src/gui/preview_panel_v2.py`, `src/gui/panels_v2/queue_panel_v2.py`, `src/controller/pipeline_controller.py`, `src/utils/queue_helpers_v2.py`, `tests/controller/test_job_queue_integration_v2.py`, `src/pipeline/job_models_v2.py`, `tests/pipeline/test_job_builder_v2.py`, `docs/ARCHITECTURE_v2.5.md`).
- [PR-CORE-B] Deterministic Job Construction Backbone (V2.6) - Adds `PromptPackNormalizedJobBuilder`, tuned resolvers, and controller wiring so each PromptPack draft expands through ConfigMergerV2 → UnifiedPromptResolver → UnifiedConfigResolver → RandomizerEngineV2 → JobBuilderV2 into deterministic NormalizedJobRecords that include embeddings, LoRA tags, stage chains, matrix slots, and pack metadata before preview/queue/history consumes them (files: `src/controller/pipeline_controller.py`, `src/pipeline/prompt_pack_job_builder.py`, `src/gui/app_state_v2.py`, `tests/pipeline/test_prompt_pack_job_builder.py`, `docs/ARCHITECTURE_v2.6.md`).
- [PR-C] Single-prompt preview → queue → run (V2.5) - Adds `AppController` helpers plus sidebar shortcuts so the Pipeline tab’s Add-to-Job workflow stores a single-prompt draft inside `AppStateV2.job_draft`, PreviewPanelV2 either shows normalized `JobUiSummary` records (via `PipelineController.get_preview_jobs`) or the draft summary, and the new enqueue/clear actions flow through `PipelineController.enqueue_draft_bundle` + job history so queue/history panels stay in sync (files: `src/controller/app_controller.py`, `src/gui/sidebar_panel_v2.py`, `src/gui/views/pipeline_tab_frame_v2.py`, `src/gui/preview_panel_v2.py`, `tests/controller/test_app_controller_pipeline_draft_v2.py`, `tests/gui_v2/test_sidebar_panel_v2_add_to_job.py`, `docs/ARCHITECTURE_v2.5.md`).
- [PR-S1] Unified Debug Hub (V2.5) - Adds `DebugHubPanelV2`, a tabbed window exposing diagnostics (pipeline, prompts, API logs, process inspector, crash bundles, system snapshot) via a single Debug button in the header, plus `AppController.open_debug_hub()` wiring and regression coverage in `tests/gui_v2/test_debug_hub_panel_v2.py` so the consolidated tooling remains consistent (files: `src/gui/panels_v2/debug_hub_panel_v2.py`, `src/gui/main_window_v2.py`, `src/controller/app_controller.py`, `tests/gui_v2/test_debug_hub_panel_v2.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`).
- [PR-S2] Explain This Job (V2.5) - Adds `JobExplanationPanelV2` plus toolbar/context actions so Debug Hub and Job History can explain a job's origin, prompts/negatives, and manifests by reading `runs/<job_id>/run_metadata.json` and stage JSON files without leaving the GUI (files: `src/gui/panels_v2/debug_hub_panel_v2.py`, `src/gui/panels_v2/job_explanation_panel_v2.py`, `src/gui/job_history_panel_v2.py`, `src/controller/app_controller.py`, `tests/gui_v2/test_job_explanation_panel_v2.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`, `docs/DEBUG_HUB_v2.5.md`).
- [PR-S4] Background auto-scanner (V2.5) - Adds `ProcessAutoScannerService`, integrates it with `AppController`, and exposes toggles/status in the Debug Hub process tab so stray Python processes are detected/killed automatically with configurable intervals and idle/memory thresholds (files: `src/controller/process_auto_scanner_service.py`, `src/controller/app_controller.py`, `src/gui/panels_v2/debug_hub_panel_v2.py`, `tests/utils/test_process_auto_scanner_service.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`, `docs/DEBUG_HUB_v2.5.md`).
- [PR-C] Thin pipeline logging & error surfacing (V2.5) - Adds pipeline-focused structured logs/envelopes whenever a job fails (`LogTracePanelV2` now only refreshes when new lines arrive, pipeline controller wraps runner exceptions via `UnifiedErrorEnvelope`, and AppController surfaces the envelope to AppState, status text, and the error modal) so users see legible job failure messages while diagnostics retain the envelope (files: `src/gui/log_trace_panel_v2.py`, `src/controller/pipeline_controller.py`, `src/controller/app_controller.py`, `src/utils/error_envelope_v2.py`, `tests/controller/test_app_controller_job_failure_v2.py`).
- [PR-0121] Phase 1: External-process lifecycle integration (V2.5) - JobService now stores external PIDs on each job, `cancel_current` scans the queue for the active job, and GUI cancel actions call `JobService.cancel_current()` before touching the queue so cleanup happens deterministically (files: `src/controller/job_service.py`, `src/controller/app_controller.py`, `tests/controller/test_job_service_process_cleanup.py`, `tests/gui_v2/test_gui_cancel_process_cleanup.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`).
- [PR-0122] Phase 2: Memory-hygiene child scripts (V2.5) – Added memory-safe helpers for legacy a1111 batch/upscale helpers, ensuring files, buffers, and sessions are released before each iteration along with script-level tests and documentation updates (files: `scripts/a1111_batch_run.py`, `scripts/a1111_upscale_folder.py`, `tests/scripts/test_batch_run_memory_hygiene.py`, `tests/scripts/test_upscale_memory_hygiene.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`).
- [PR-0123] Phase 3: Watchdog + resource caps (V2.5) – `JobWatchdog` threads inspect tracked PIDs for RSS/runtime/idle violations, log `[WATCHDOG]` entries, and cancel jobs when the caps defined via `STABLENEW_WATCHDOG_*` are exceeded while keeping cleanup inside JobService (files: `src/controller/job_service.py`, `src/utils/watchdog_v2.py`, `src/config/app_config.py`, `tests/utils/test_watchdog_v2.py`, `tests/controller/test_job_service_watchdog.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`, `docs/KNOWN_PITFALLS_QUEUE_TESTING.md`).
- [PR-0124] Phase 4: OS-level containment (V2.5) – JobService now places every child PID into an OS job object (Windows) or cgroup v2 (Linux), logs `[CONTAINER]` events, and enforces container-level caps configured via `STABLENEW_PROCESS_CONTAINER_*` so OS-level shutdown is guaranteed (files: `src/controller/job_service.py`, `src/config/app_config.py`, `src/utils/process_container_v2.py`, `src/utils/win_jobobject.py`, `src/utils/cgroup_v2.py`, `tests/controller/test_job_service_container_cleanup.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`, `docs/KNOWN_PITFALLS_QUEUE_TESTING.md`).
- [PR-0125] Phase 5: Diagnostics dashboard & crash reporting (V2.5) ƒ?" Adds `DiagnosticsDashboardV2`, the LogTracePanel "Crash Bundle" button, and AppController crash-report hooks so every watchdog violation, uncaught exception, or manual request writes an anonymized `.zip` to `reports/diagnostics/` containing logs, job metadata, process info, and system stats (files: `src/controller/app_controller.py`, `src/gui/views/diagnostics_dashboard_v2.py`, `src/gui/log_trace_panel_v2.py`, `src/utils/diagnostics_bundle_v2.py`, `src/utils/system_info_v2.py`, `tests/gui_v2/test_diagnostics_dashboard_v2.py`, `tests/controller/test_app_controller_diagnostics.py`, `tests/utils/test_diagnostics_bundle_v2.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`, `docs/KNOWN_PITFALLS_QUEUE_TESTING.md`).
- [PR-0126] Phase 6: Unified Error Model & Exception Taxonomy (V2.5) - Introduces `UnifiedErrorEnvelope`, taxonomy exceptions, and structured logging so every subsystem (pipeline runner, executor, JobService, watchdog, controller) wraps failures, surfaces envelopes in logs/diagnostics, and shows `ErrorModalV2` for user remediation plus crash bundles that carry the serialized envelope (files: `src/utils/error_envelope_v2.py`, `src/utils/exceptions_v2.py`, `src/pipeline/pipeline_runner.py`, `src/pipeline/executor.py`, `src/controller/job_service.py`, `src/controller/app_controller.py`, `src/gui/log_trace_panel_v2.py`, `src/gui/views/error_modal_v2.py`, `src/utils/watchdog_v2.py`, `tests/gui_v2/test_error_modal_v2.py`, `tests/gui_v2/test_log_trace_panel_v2.py`, `tests/controller/test_app_controller_pipeline_flow_pr0.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`).
- [PR-0129] Phase 9: Job snapshotting & deterministic replay (V2.5) - Adds `SnapshotBuilderV2`, persists job snapshots in history entries, and exposes a "Replay Job" button so AppController/PipelineController can rebuild previews and requeue jobs from past runs without touching the runner internals (files: `src/utils/snapshot_builder_v2.py`, `src/controller/pipeline_controller.py`, `src/controller/app_controller.py`, `src/gui/job_history_panel_v2.py`, `src/queue/job_model.py`, `src/queue/job_history_store.py`, `src/controller/job_history_service.py`, `tests/utils/test_snapshot_builder_v2.py`, `tests/controller/test_pipeline_replay_job_v2.py`, `tests/gui_v2/test_job_history_panel_v2.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`, `docs/ARCHITECTURE_v2.5.md`).
- [PR-0130] Phase 10: Automated snapshot-based regression suite (V2.5) - Adds curated snapshot fixtures plus regression tests that replay them through the PipelineController → JobService path using stubbed runners, keeping Phase 9 replay wiring regression-safe (files: `tests/data/snapshots/job_snapshot_simple_txt2img.json`, `tests/data/snapshots/job_snapshot_txt2img_refiner_hires.json`, `tests/data/snapshots/job_snapshot_pack_randomized_batch.json`, `tests/data/snapshots/README.md`, `tests/regression/test_snapshot_regression_v2.py`, `pytest.ini`, `src/controller/pipeline_controller.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`, `docs/DOCS_INDEX_v2.5.md`).
- [PR-U1] Prompt pack propagation, global negative merge, and upscale payload fix (V2.5) - Normalized jobs now record prompt metadata for preview/manifests, `merge_global_negative` keeps the user negative separate from the appended global terms, upscale payloads send a proper `data:image/png;base64` body and log clean stage-tagged failures, and run metadata/manifests include pack usage information so GUI + diagnostics accurately reflect the prompts that launched each job (files: `src/pipeline/job_builder_v2.py`, `src/pipeline/job_models_v2.py`, `src/gui/preview_panel_v2.py`, `src/pipeline/payload_builder.py`, `src/pipeline/executor.py`, `src/pipeline/pipeline_runner.py`, `src/learning/run_metadata.py`, `src/api/client.py`, `tests/api/test_webui_api_upscale_payload.py`, `tests/utils/test_negative_helpers_v2.py`, `tests/gui_v2/test_preview_panel_v2_normalized_jobs.py`, `tests/pipeline/test_job_builder_v2.py`, `tests/learning_v2/test_run_metadata_and_feedback.py`).

### Changed
- [PR-GUI-H] Window Management & Layout Fixes (V2.5) — MainWindowV2 now enforces default/min window geometry and each Pipeline tab column wraps its cards in a single `ScrollableFrame`, improving first-launch visibility (files: `src/gui/main_window_v2.py`, `src/gui/views/pipeline_tab_frame_v2.py`, `tests/gui_v2/test_window_layout_normalization_v2.py`).
- [PR-GUI-I] GUI Validation Color Normalization (V2.5) – Added canonical validation color tokens and helper functions, recolored prompt pack and randomizer panels to use the theme palette, and documented the GUI normalization milestone (files: `src/gui/theme_v2.py`, `src/gui/prompt_pack_panel_v2.py`, `src/gui/randomizer_panel_v2.py`, `docs/Roadmap_v2.5.md`, `tests/gui_v2/test_color_validation.py`).
- [PR-0114C-Q] Queue/Runner State Transitions & Payload Enforcement (V2.5) – JobQueue now notifies JobService of every state change so `EVENT_JOB_STARTED`, `EVENT_JOB_FINISHED`, and `EVENT_JOB_FAILED` fire consistently, improving queue lifecycle determinism and supporting the new queue tests (files: `src/queue/job_queue.py`, `src/controller/job_service.py`, `tests/controller/test_job_service_unit.py`, `docs/ARCHITECTURE_v2.5.md`, `docs/StableNew_Coding_and_Testing_v2.5.md`).
- [PR-0114C-H] JobService → History Wiring & Completion Recording (V2.5) – JobService now forwards completed and failed jobs through JobHistoryService so HistoryStore captures final metadata and notifies listeners (files: `src/controller/job_service.py`, `src/controller/job_history_service.py`, `src/queue/job_history_store.py`, `tests/controller/test_job_service_history_v2.py`, `tests/history/test_history_store_recording_v2.py`, `docs/ARCHITECTURE_v2.5.md`, `docs/StableNew_Coding_and_Testing_v2.5.md`).
- [PR-0114C-Tx] Test DI for Queue/Runner/History (V2.5) – Added dependency injection hooks to JobService (`runner_factory`, `run_callable`) enabling tests to use `StubRunner` and `NullHistoryService` instead of real execution. This prevents controller/GUI tests from spawning worker threads or calling SD/WebUI while preserving full production behavior (files: `src/controller/job_service.py`, `src/controller/job_history_service.py`, `src/queue/stub_runner.py`, `tests/controller/conftest.py`, `tests/controller/test_job_service_di_v2.py`).

## [2.1.0] - 2025-11-21
### Added
- Full adoption of StableNew V2 architecture.
- Stage cards, adapters, sequencer, learning metadata stack.
- Randomizer V2 with advanced UX.
- AI Settings Generator stubs.
- Safety wrapper enforcement.
- GUI V2-only test harness.
- New roadmap and pivot explanation.

### Changed
- main_window.py partially modularized.
- Randomizer import surface isolated.
- Legacy GUI tests migrated.

### Fixed
- Theme constants restored.
- Randomizer rotate behavior corrected.

### Known Issues
- Stage-event emissions pending executor wiring.
- Some GUI tests skipped when Tk/Tcl unavailable.
