# Changelog

## [Unreleased]

### Added
- [PR-A] Core run path & runner DI (V2.5) - AppController now builds JobService through a dedicated runner factory so `_execute_job` drives SingleNodeJobRunner, PipelineController relies on that same JobService, and new controller tests (plus docs) verify the DI-driven path without touching real runners (files: `src/controller/app_controller.py`, `src/controller/pipeline_controller.py`, `tests/controller/test_core_run_path_v2.py`, `docs/ARCHITECTURE_v2.5.md`, `docs/StableNew_Coding_and_Testing_v2.5.md`, `docs/pr_templates/PR-A-CoreRunPath_and_Runner_DI_v2.5.md`).
- [PR-0128] Phase 8: Unified logging & telemetry harmonization (V2.5) - Centralizes `log_with_ctx`, adds JSONL sink + handler, wires AppController to the structured log stream for crash bundles, and extends `LogTracePanelV2` with subsystem/job filters so GUI logs now follow a single schema across phases 5-8 (files: `src/utils/logger.py`, `src/controller/app_controller.py`, `src/utils/diagnostics_bundle_v2.py`, `src/gui/log_trace_panel_v2.py`, `tests/utils/test_logger_v2.py`, `tests/gui_v2/test_log_display_v2.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`, `docs/pr_templates/PR-0128–Phase8_UnifiedLogging_and_Telemetry_v2.5.md`).
- [PR-0127] Phase 7: Retry semantics & intelligent recovery (V2.5) - Introduces `RetryPolicy` stage defaults, `SDWebUIClient` retry callbacks/backoff logging, `JobExecutionMetadata.retry_attempts`, structured retry envelopes, and targeted tests/documentation so transient WebUI failures are retried while crash bundles capture each attempt (files: `src/api/client.py`, `src/utils/retry_policy_v2.py`, `src/controller/job_service.py`, `src/controller/pipeline_controller.py`, `src/queue/job_model.py`, `src/queue/single_node_runner.py`, `tests/api/test_webui_retry_policy_v2.py`, `tests/controller/test_job_retry_metadata_v2.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`, `docs/pr_templates/PR-0127-Phase7_RetrySemantics_and_IntelligentRecovery_v2.5.md`).
- [PR-B] GUI job wiring & queue integration (V2.5) - PipelineTabFrame now binds AppStateV2 to PipelineController so preview jobs reflect normalized records, queue items derive from JobService state, and Queue/Running panels dispatch moves, pauses, and cancels through the canonical controller/JobService path (files: `src/gui/app_state_v2.py`, `src/gui/views/pipeline_tab_frame_v2.py`, `src/gui/preview_panel_v2.py`, `src/gui/panels_v2/queue_panel_v2.py`, `src/controller/pipeline_controller.py`, `src/utils/queue_helpers_v2.py`, `tests/controller/test_job_queue_integration_v2.py`).
- [PR-C] Thin pipeline logging & error surfacing (V2.5) - Adds pipeline-focused structured logs/envelopes whenever a job fails (`LogTracePanelV2` now only refreshes when new lines arrive, pipeline controller wraps runner exceptions via `UnifiedErrorEnvelope`, and AppController surfaces the envelope to AppState, status text, and the error modal) so users see legible job failure messages while diagnostics retain the envelope (files: `src/gui/log_trace_panel_v2.py`, `src/controller/pipeline_controller.py`, `src/controller/app_controller.py`, `src/utils/error_envelope_v2.py`, `tests/controller/test_app_controller_job_failure_v2.py`).
- [PR-0121] Phase 1: External-process lifecycle integration (V2.5) - JobService now stores external PIDs on each job, `cancel_current` scans the queue for the active job, and GUI cancel actions call `JobService.cancel_current()` before touching the queue so cleanup happens deterministically (files: `src/controller/job_service.py`, `src/controller/app_controller.py`, `tests/controller/test_job_service_process_cleanup.py`, `tests/gui_v2/test_gui_cancel_process_cleanup.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`).
- [PR-0122] Phase 2: Memory-hygiene child scripts (V2.5) – Added memory-safe helpers for legacy a1111 batch/upscale helpers, ensuring files, buffers, and sessions are released before each iteration along with script-level tests and documentation updates (files: `scripts/a1111_batch_run.py`, `scripts/a1111_upscale_folder.py`, `tests/scripts/test_batch_run_memory_hygiene.py`, `tests/scripts/test_upscale_memory_hygiene.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`).
- [PR-0123] Phase 3: Watchdog + resource caps (V2.5) – `JobWatchdog` threads inspect tracked PIDs for RSS/runtime/idle violations, log `[WATCHDOG]` entries, and cancel jobs when the caps defined via `STABLENEW_WATCHDOG_*` are exceeded while keeping cleanup inside JobService (files: `src/controller/job_service.py`, `src/utils/watchdog_v2.py`, `src/config/app_config.py`, `tests/utils/test_watchdog_v2.py`, `tests/controller/test_job_service_watchdog.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`, `docs/KNOWN_PITFALLS_QUEUE_TESTING.md`).
- [PR-0124] Phase 4: OS-level containment (V2.5) – JobService now places every child PID into an OS job object (Windows) or cgroup v2 (Linux), logs `[CONTAINER]` events, and enforces container-level caps configured via `STABLENEW_PROCESS_CONTAINER_*` so OS-level shutdown is guaranteed (files: `src/controller/job_service.py`, `src/config/app_config.py`, `src/utils/process_container_v2.py`, `src/utils/win_jobobject.py`, `src/utils/cgroup_v2.py`, `tests/controller/test_job_service_container_cleanup.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`, `docs/KNOWN_PITFALLS_QUEUE_TESTING.md`).
- [PR-0125] Phase 5: Diagnostics dashboard & crash reporting (V2.5) ƒ?" Adds `DiagnosticsDashboardV2`, the LogTracePanel "Crash Bundle" button, and AppController crash-report hooks so every watchdog violation, uncaught exception, or manual request writes an anonymized `.zip` to `reports/diagnostics/` containing logs, job metadata, process info, and system stats (files: `src/controller/app_controller.py`, `src/gui/views/diagnostics_dashboard_v2.py`, `src/gui/log_trace_panel_v2.py`, `src/utils/diagnostics_bundle_v2.py`, `src/utils/system_info_v2.py`, `tests/gui_v2/test_diagnostics_dashboard_v2.py`, `tests/controller/test_app_controller_diagnostics.py`, `tests/utils/test_diagnostics_bundle_v2.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`, `docs/KNOWN_PITFALLS_QUEUE_TESTING.md`).
- [PR-0126] Phase 6: Unified Error Model & Exception Taxonomy (V2.5) – Introduces `UnifiedErrorEnvelope`, taxonomy exceptions, and structured logging so every subsystem (pipeline runner, executor, JobService, watchdog, controller) wraps failures, surfaces envelopes in logs/diagnostics, and shows `ErrorModalV2` for user remediation plus crash bundles that carry the serialized envelope (files: `src/utils/error_envelope_v2.py`, `src/utils/exceptions_v2.py`, `src/pipeline/pipeline_runner.py`, `src/pipeline/executor.py`, `src/controller/job_service.py`, `src/controller/app_controller.py`, `src/gui/log_trace_panel_v2.py`, `src/gui/views/error_modal_v2.py`, `src/utils/watchdog_v2.py`, `tests/gui_v2/test_error_modal_v2.py`, `tests/gui_v2/test_log_trace_panel_v2.py`, `tests/controller/test_app_controller_pipeline_flow_pr0.py`, `docs/StableNew_Coding_and_Testing_v2.5.md`).

### Changed
- [PR-GUI-H] Window Management & Layout Fixes (V2.5) — MainWindowV2 now enforces default/min window geometry and each Pipeline tab column wraps its cards in a single `ScrollableFrame`, improving first-launch visibility (files: `src/gui/main_window_v2.py`, `src/gui/views/pipeline_tab_frame_v2.py`, `tests/gui_v2/test_window_layout_normalization_v2.py`).
- [PR-GUI-I] GUI Validation Color Normalization (V2.5) – Added canonical validation color tokens and helper functions, recolored prompt pack and randomizer panels to use the theme palette, and documented the GUI normalization milestone (files: `src/gui/theme_v2.py`, `src/gui/prompt_pack_panel_v2.py`, `src/gui/randomizer_panel_v2.py`, `docs/Roadmap_v2.5.md`, `tests/gui_v2/test_color_validation.py`).
- [PR-0114C-Q] Queue/Runner State Transitions & Payload Enforcement (V2.5) – JobQueue now notifies JobService of every state change so `EVENT_JOB_STARTED`, `EVENT_JOB_FINISHED`, and `EVENT_JOB_FAILED` fire consistently, improving queue lifecycle determinism and supporting the new queue tests (files: `src/queue/job_queue.py`, `src/controller/job_service.py`, `tests/controller/test_job_service_unit.py`, `docs/ARCHITECTURE_v2.5.md`, `docs/StableNew_Coding_and_Testing_v2.5.md`).
- [PR-0114C-H] JobService → History Wiring & Completion Recording (V2.5) – JobService now forwards completed and failed jobs through JobHistoryService so HistoryStore captures final metadata and notifies listeners (files: `src/controller/job_service.py`, `src/controller/job_history_service.py`, `src/queue/job_history_store.py`, `tests/controller/test_job_service_history_v2.py`, `tests/history/test_history_store_recording_v2.py`, `docs/ARCHITECTURE_v2.5.md`, `docs/StableNew_Coding_and_Testing_v2.5.md`).
- [PR-0114C-Tx] Test DI for Queue/Runner/History (V2.5) – Added dependency injection hooks to JobService (`runner_factory`, `run_callable`) enabling tests to use `StubRunner` and `NullHistoryService` instead of real execution. This prevents controller/GUI tests from spawning worker threads or calling SD/WebUI while preserving full production behavior (files: `src/controller/job_service.py`, `src/controller/job_history_service.py`, `src/queue/stub_runner.py`, `tests/controller/conftest.py`, `tests/controller/test_job_service_di_v2.py`).

## [2.1.0] - 2025-11-21
### Added
- Full adoption of StableNew V2 architecture.
- Stage cards, adapters, sequencer, learning metadata stack.
- Randomizer V2 with advanced UX.
- AI Settings Generator stubs.
- Safety wrapper enforcement.
- GUI V2-only test harness.
- New roadmap and pivot explanation.

### Changed
- main_window.py partially modularized.
- Randomizer import surface isolated.
- Legacy GUI tests migrated.

### Fixed
- Theme constants restored.
- Randomizer rotate behavior corrected.

### Known Issues
- Stage-event emissions pending executor wiring.
- Some GUI tests skipped when Tk/Tcl unavailable.
